import numpy as np
import pandas as pd
import torch
import torch.nn.functional as F

def interpolate(data, size):
    sizes = {107:
        [
        [53, 54, 55, 56, 57],
        [64, 65, 66, 67, 68, 69, 70],
        [75, 76, 77, 78, 79, 80, 81, 82],
        [87, 88, 89, 90, 91, 92, 93, 94],
        [98, 99, 100, 101, 102, 103, 104, 105, 106],
        [110, 111, 112, 113, 114, 115, 116, 117, 118],
        [122, 123, 124, 125, 126, 127, 128, 129, 130],
        [135, 136, 137, 138, 139, 140, 141],
        [147, 148, 149, 150, 151, 152, 153],
        [159, 160, 161, 162, 163, 164, 165],
        [171, 172, 173, 174, 175, 176, 177],
        [183, 184, 185, 186, 187, 188, 189],
        [195, 196, 197, 198, 199, 200, 201],
        [208, 209, 210, 211, 212, 213],
        [221, 222, 223, 224],
    ],
    116:[
        [41,42,43,44,45],
        [52, 53, 54, 55, 56, 57, 58],
        [63, 64, 65, 66, 67, 68, 69, 70, 71],
        [75, 76, 77, 78, 79, 80, 81, 82, 83],
        [86, 87, 88, 89, 90, 91, 92, 93, 94, 95],
        [98, 99, 100, 101, 102, 103, 104, 105, 106, 107],
        [111, 112, 113, 114, 115, 116, 117, 118],
        [123, 124, 125, 126, 127, 128, 129, 130],
        [135, 136, 137, 138, 139, 140, 141, 142],
        [147, 148, 149, 150, 151, 152, 153, 154],
        [159, 160, 161, 162, 163, 164, 165, 166],
        [171, 172, 173, 174, 175, 176, 177, 178],
        [183, 184, 185, 186, 187, 188, 189],
        [196, 197, 198, 199, 200, 201],
        [208, 209, 210,
         211, 212],
    ],
    130:[
        [41,42,43,44,45,46],
        [52, 53, 54, 55, 56, 57, 58],
        [63, 64, 65, 66, 67, 68, 69, 70, 71],
        [75, 76, 77, 78, 79, 80, 81, 82, 83],
        [86, 87, 88, 89, 90, 91, 92, 93, 94, 95],
        [98, 99, 100, 101, 102, 103, 104, 105, 106, 107],
        [110, 111, 112, 113, 114, 115, 116, 117, 118],
        [122, 123, 124, 125, 126, 127, 128, 129, 130],
        [135, 136, 137, 138, 139, 140, 141, 142],
        [147, 148, 149, 150, 151, 152, 153, 154],
        [159, 160, 161, 162, 163, 164, 165, 166],
        [171, 172, 173, 174, 175, 176, 177, 178],
        [183, 184, 185, 186, 187, 188, 189, 190],
        [195, 196, 197, 198, 199, 200, 201, 202],
        [208, 209, 210, 211, 212, 213, 214],
        [220, 221, 222, 223, 224, 225],
    ],
    151:[
        [29,30,31,32,33,34],
        [40,41,42,43,44,45,46,47],
        [51, 52, 53, 54, 55, 56, 57, 58, 59],
        [62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72],
        [74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84],
        [86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96],
        [98, 99, 100, 101, 102, 103, 104, 105, 106, 107],
        [110, 111, 112, 113, 114, 115, 116, 117, 118, 119],
        [122, 123, 124, 125, 126, 127, 128, 129, 130, 131],
        [135, 136, 137, 138, 139, 140, 141, 142, 143],
        [147, 148, 149, 150, 151, 152, 153, 154, 155],
        [159, 160, 161, 162, 163, 164, 165, 166, 167],
        [171, 172, 173, 174, 175, 176, 177, 178, 179],
        [183, 184, 185, 186, 187, 188, 189, 190, 191],
        [195, 196, 197, 198, 199, 200, 201, 202],
        [208, 209, 210, 211, 212, 213, 214],
        [221, 222, 223, 224, 225]
    ]}

    current_size = sizes[size]
    
    max_width = max([len(x) for x in current_size])
    height = len(current_size)
    
    map = np.zeros([len(data), 11*max_width, 17*height])
    sensor_to_coord = {}
    
    for y, row in enumerate(current_size):
        for x, sensor in enumerate(row):
            sensor_to_coord[sensor] = (x + max_width-len(row), y)
    
    for key in data.columns:
        x, y = sensor_to_coord[int(key)]
        x_start = (map.shape[1]//max_width)*x
        x_end = (map.shape[1]//max_width)*(x+1)
        y_start = (map.shape[2]//height)*y
        y_end = (map.shape[2]//height)*(y+1)
        
        tile_h = map.shape[1] // max_width
        tile_w = map.shape[2] // height

        values = data[key].to_numpy()[:, None, None]
        values = np.broadcast_to(values, (len(data), tile_h, tile_w))
        map[:,x_start:x_end,y_start:y_end] = values
    map = torch.Tensor(map).unsqueeze(1)
    map = F.avg_pool2d(map, kernel_size=(max_width, height))
    inverse_map = np.empty([len(data), 151])
    map = map.squeeze(1)
    for i, value in enumerate(sensor_to_coord.values()):
        inverse_map[:,i] = map[:,value[0], value[1]]
        
    
    return inverse_map
    
        
    
    
    